<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width = device-width, initial-scale = 1">

    <title>Mechanism Browser</title>
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="styles.css">
</head>

<body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<div class="top-nav-wrapper">
    <div class="top-nav-fixed">
        <div class="container">
            <a href="https://github.com/janetzki/Mechanism-Browser">
                <img src="../media/octocat%20white.svg">
            </a>
        </div>
    </div>
</div>

<div class="top-nav">
    <div class="container">
        <div class="page-header">
            <img src="media/logo%20horizontal.svg">
            <div style="display: none">Gear icon made by <a href="http://www.freepik.com"
                                                            title="Freepik">Freepik</a> from <a
                    href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a> is licensed by <a
                    href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0"
                    target="_blank">CC 3.0 BY</a></div>
        </div>
    </div>
    <div class="container">
        <div class="row">
            <div id="inputColumn" class="column">
                <h3>Input</h3>
                <img class="icon" id="inputR1" src="icons/r1.png" onclick=toggleImage(this)>
                <img class="icon" id="inputR2" src="icons/r2.png" onclick=toggleImage(this)>
                <img class="icon" id="inputR3" src="icons/r3.png" onclick=toggleImage(this)>
                <img class="icon" id="inputT1" src="icons/t1.png" onclick=toggleImage(this)>
                <img class="icon" id="inputT2" src="icons/t2.png" onclick=toggleImage(this)>
                <img class="icon" id="inputT3" src="icons/t3.png" onclick=toggleImage(this)>
            </div>
            <div id="outputColumn" class="column">
                <h3>Output</h3>
                <img class="icon" id="outputR1" src="icons/r1.png" onclick=toggleImage(this)>
                <img class="icon" id="outputR2" src="icons/r2.png" onclick=toggleImage(this)>
                <img class="icon" id="outputR3" src="icons/r3.png" onclick=toggleImage(this)>
                <img class="icon" id="outputT1" src="icons/t1.png" onclick=toggleImage(this)>
                <img class="icon" id="outputT2" src="icons/t2.png" onclick=toggleImage(this)>
                <img class="icon" id="outputT3" src="icons/t3.png" onclick=toggleImage(this)>
            </div>
            <div id="matrixColumn" class="column" style="display: none">
                <table id='matrix' class='matrix' cellpadding="10" align="center">
                    <tr>
                        <td></td>
                        <td colspan='6' align='center'><h3>Output</h3></td>
                    </tr>
                    <tr>
                        <td><h3>Input</h3></td>
                        <td id="outputR1Placeholder"></td>
                        <td id="outputR2Placeholder"></td>
                        <td id="outputR3Placeholder"></td>
                        <td id="outputT1Placeholder"></td>
                        <td id="outputT2Placeholder"></td>
                        <td id="outputT3Placeholder"></td>
                    </tr>
                    <tr>
                        <td id="inputR1Placeholder"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td id="inputR2Placeholder"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td id="inputR3Placeholder"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td id="inputT1Placeholder"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td id="inputT2Placeholder"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td id="inputT3Placeholder"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                </table>
            </div>
            <div class="column">
                <h3>More</h3>
                <div class="form-group">
                    <label for="transmission">Transmission</label>
                    <input type="number" class="form-control" id="transmission" placeholder="number">
                </div>
                <div class="form-group">
                    <label for="name">Name</label>
                    <input type="search" class="form-control" id="name" placeholder="text">
                </div>
                <div class="btn-group action vertical-button" data-toggle="buttons">
                    <label class="btn btn-primary active">
                        <input type="radio" name="radioMatrix" autocomplete="off" value=true checked> Complete
                    </label>
                    <label class="btn btn-primary">
                        <input type="radio" name="radioMatrix" autocomplete="off" value=""> Any
                    </label>
                    <label class="btn btn-primary">
                        <input type="radio" name="radioMatrix" value=false autocomplete="off"> Incomplete
                    </label>
                </div>
                <div class="btn-group action vertical-button" data-toggle="buttons">
                    <label class="btn btn-primary active">
                        <input type="radio" name="radioInputMode" autocomplete="off" checked> Basic
                    </label>
                    <label class="btn btn-primary">
                        <input id="radioMatrixInput" type="radio" name="radioInputMode" autocomplete="off"> Matrix
                    </label>
                </div>
            </div>
            <div class="column">
                <h3>Actions</h3>
                <button class="btn btn-primary action vertical-button"
                        type="button"
                        onclick="searchMechanism()">
                    Search
                </button>
                <button class="btn btn-primary action vertical-button"
                        type="button"
                        onclick="createMechanism()">
                    Create
                </button>
            </div>
        </div>
    </div>
</div>

<div class="container-for-footer background">
    <div class="background-overlay">
        <div id="content" class="content content-box container" style="display: none;">
            <div class="search-result" data-type="template" style="display: none">
                <a class="mechanism-name">
                    title
                </a>
                <div>
                    <a class="image-link"><img src="" class="preview-image" align="left"></a>
                    <a class="mechanism-link">
                        link
                    </a>
                    <div class="mechanism-description">
                        description
                    </div>
                    <div class="mechanism-parameters">
                        <div class="axes-line">
                            <img class="small-icon inputR1">
                            <img class="small-icon inputR2">
                            <img class="small-icon inputR3">
                            <img class="small-icon inputT1">
                            <img class="small-icon inputT2">
                            <img class="small-icon inputT3">
                        </div>
                        <div class="axes-line">
                            <img class="small-icon outputR1">
                            <img class="small-icon outputR2">
                            <img class="small-icon outputR3">
                            <img class="small-icon outputT1">
                            <img class="small-icon outputT2">
                            <img class="small-icon outputT3">
                        </div>
                    </div>
                    <div>
                        <div class="mechanism-rating">
                            rating
                        </div>
                        <span class="glyphicon glyphicon-star" aria-hidden="true"></span>
                        <p class="mechanism-incomplete-note">incomplete</p>
                    </div>
                </div>
            </div>
            <div class="content container" style="padding-bottom: 3em">
                <p id="resultInfo" style="color: gray"></p>
                <div id="mechanisms">
                </div>
            </div>
        </div>
    </div>

    <footer id="pageInfo" class="bottom-nav" style="display: none; position: fixed">
        <div align="center">
            <button id="firstPage"
                    class="btn btn-default action"
                    type="button">
                <<
            </button>
            <button id="previousPage"
                    class="btn btn-default action"
                    type="button">
                <
            </button>
            <p id="pageInfoText" class="bottom-nav-text"></p>
            <button id="nextPage"
                    class="btn btn-default action"
                    type="button">
                >
            </button>
            <button id="lastPage"
                    class="btn btn-default action"
                    type="button">
                >>
            </button>
        </div>
    </footer>
</div>
</body>
<script>
    function setImage(img, baseFileName, value, tristate = false) {
        baseFileName = baseFileName
            .replace('input', '')
            .replace('output', '')
            .toLowerCase();
        switch (value) {
            case true:
                img.src = 'icons/' + baseFileName + '_selected.png';
                break;
            case false:
                if (tristate) {
                    img.src = 'icons/' + baseFileName + '_deselected.png';
                } else {
                    img.src = 'icons/' + baseFileName + '.png';
                }
                break;
            default:
                // ''
                img.src = 'icons/' + baseFileName + '.png';
        }
    }

    function toggleImage(img) {
        switch ($(img).data('status')) {
            case true:
                $(img).data('status', false);
                break;
            case false:
                $(img).data('status', '');
                break;
            default:
                // ''
                $(img).data('status', true);
        }
        setImage(img, img.id, $(img).data('status'), true);
        updateMatrix();
    }

    const selectedMatrixCells = [...Array(6)].map(x => Array(6).fill(false));

    function getParameters() {
        const parameters = {
            inputR1: $('#inputR1').data('status'),
            inputR2: $('#inputR2').data('status'),
            inputR3: $('#inputR3').data('status'),
            inputT1: $('#inputT1').data('status'),
            inputT2: $('#inputT2').data('status'),
            inputT3: $('#inputT3').data('status'),
            outputR1: $('#outputR1').data('status'),
            outputR2: $('#outputR2').data('status'),
            outputR3: $('#outputR3').data('status'),
            outputT1: $('#outputT1').data('status'),
            outputT2: $('#outputT2').data('status'),
            outputT3: $('#outputT3').data('status'),
            transmission: document.querySelector("#transmission").value,
            name: document.querySelector("#name").value,
            complete: document.querySelector('input[name="radioMatrix"]:checked').value
        };

        // read matrix
        if (document.getElementById('radioMatrixInput').checked) {
            for (let x = 0; x < 6; x++) {
                for (let y = 0; y < 6; y++) {
                    const inputAxis = 'input' + mapNumberToAxis(y);
                    const outputAxis = 'output' + mapNumberToAxis(x);
                    if (selectedMatrixCells[y][x]) {
                        if (parameters[inputAxis] === undefined) {
                            parameters[inputAxis] = true;
                        }
                        if (parameters[outputAxis] === undefined) {
                            parameters[outputAxis] = true;
                        }
                    }
                }
            }
        }

        // remove undefined parameters
        for (const key of Object.keys(parameters)) {
            if (parameters[key] === undefined || parameters[key] === '') {
                delete parameters[key];
            }
        }
        return parameters;
    }

    function getUrlWithParameters(baseUrl, parameters) {
        let url = new URL(baseUrl);
        for (const key of Object.keys(parameters)) {
            url.searchParams.append(key, parameters[key]);
        }
        return url;
    }

    function showResultInfo(responseLength) {
        const resultInfo = document.getElementById('resultInfo');
        if (responseLength === 1) {
            resultInfo.innerText = '1 result';
        } else {
            resultInfo.innerText = responseLength + ' results';
            if (responseLength === 0) {
                const url = getUrlWithParameters('http://mechanism-browser/create/', getParameters());
                resultInfo.innerHTML = 'No results found. Do you want to <a href="' + url + '">create</a> it?';
            }
        }
    }

    function setButtonStatus(button, activated, searchUrl) {
        button.disabled = !activated;
        button.setAttribute('onclick', 'searchMechanism("' + searchUrl + '")');
    }

    String.prototype.format = function () {
        let string = this;
        for (const i in arguments) {
            string = string.replace(new RegExp('\\{' + i + '\\}', 'g'), arguments[i]);
        }
        return string
    };

    function showPageInfo(first, previous, current, next, last) {
        const pageInfo = document.getElementById('pageInfo');
        if (first === last) {
            pageInfo.style.display = 'none';
            return;
        }
        pageInfo.style.display = '';

        const lastUrl = new URL(last);
        const pages = parseInt(lastUrl.searchParams.get('page'));
        const currentPage = current;

        document.getElementById('pageInfoText').textContent = '{0}/{1}'.format(currentPage, pages);

        setButtonStatus(document.getElementById('firstPage'), currentPage !== 1, first);
        setButtonStatus(document.getElementById('previousPage'), previous !== null, previous);
        setButtonStatus(document.getElementById('nextPage'), next !== null, next);
        setButtonStatus(document.getElementById('lastPage'), currentPage !== pages, last);
    }

    function updateStyles() {
        const documentHeight = document.getElementsByTagName('html')[0].offsetHeight;
        document.getElementById('content').style.display = '';
        document.getElementsByTagName('body')[0].style.height = 'auto';
        document.getElementsByClassName('background')[0].style.minHeight = documentHeight + 'px';
        document.getElementsByClassName('background-overlay')[0].style.minHeight = documentHeight + 'px';
    }

    function showRating(entry, rating) {
        const star = entry.querySelector("span.glyphicon-star");
        entry.querySelector("div.mechanism-rating").textContent = rating;
        if (rating < 0) {
            star.style.color = "red";
        } else if (rating === 0) {
            star.style.color = "grey";
        } else {
            star.style.color = "orange";
        }
    }

    const axes = ['R1', 'R2', 'R3', 'T1', 'T2', 'T3'];

    function showParameters(entry, mechanism) {
        for (const axis of axes) {
            const inputImage = entry.querySelector('img.input' + axis);
            const outputImage = entry.querySelector('img.output' + axis);
            setImage(inputImage, 'input' + axis, mechanism.input[axis.toLowerCase()]);
            setImage(outputImage, 'output' + axis, mechanism.output[axis.toLowerCase()]);
        }
    }

    function searchMechanism(baseUrl = 'http://mechanism-browser:8000/api/mechanisms/') {
        const xhttp = new XMLHttpRequest();
        const url = getUrlWithParameters(baseUrl, getParameters());
        xhttp.open('GET', url.toString());
        xhttp.setRequestHeader('Content-type', 'application/json');
        xhttp.send();
        xhttp.onreadystatechange = function () {
            if (xhttp.readyState === 4 && xhttp.status === 200) {
                const response = JSON.parse(xhttp.responseText);
                updateStyles();
                showResultInfo(response.count);
                showPageInfo(response.first, response.previous, response.current, response.next, response.last);
                const list = document.getElementById('mechanisms');
                list.innerHTML = '';

                // https://stackoverflow.com/a/41447500/8816968
                for (const mechanismId of Object.keys(response.results)) {
                    const mechanism = response.results[mechanismId];
                    const entry = document.querySelector("div[data-type='template']").cloneNode(true);
                    entry.querySelector("a.mechanism-name").textContent = mechanism.name;
                    entry.querySelector("a.mechanism-name").href = "mechanism/" + mechanism.id;
                    entry.querySelector("a.image-link").href = "mechanism/" + mechanism.id;
                    entry.querySelector("img").src = mechanism.image.substring(1);
                    entry.querySelector("div.mechanism-description").textContent = mechanism.comments;
                    showRating(entry, mechanism.rating_likes - mechanism.rating_dislikes);
                    showParameters(entry, mechanism);
                    if (mechanism.complete === false) {
                        entry.querySelector("p.mechanism-incomplete-note").style.display = 'inline-block';
                    }
                    entry.querySelector("a.mechanism-link").textContent = mechanism.link;
                    entry.querySelector("a.mechanism-link").href = mechanism.link;
                    entry.style.display = "block";
                    list.appendChild(entry);
                }
            }
        };
    }

    function createMechanism() {
        window.location.href = getUrlWithParameters('http://mechanism-browser/create/', getParameters());
    }

    $('img[class=icon], input[type=number], input[type=search], input[type=radio]').on('change keydown paste input click', function () {
        searchMechanism();
        updateMatrix()
    });

    $('input[name="radioInputMode"]').on('change click', function () {
        toggleInputMode();
    });

    function toggleInputMode() {
        if (document.getElementById('radioMatrixInput').checked) {
            document.getElementById('inputColumn').style.display = 'none';
            document.getElementById('outputColumn').style.display = 'none';
            document.getElementById('matrixColumn').style.display = '';

            for (const io of ['input', 'output']) {
                for (const axis of axes) {
                    const axisSelector = '#' + io + axis;
                    const icon = $(axisSelector);
                    icon.appendTo($(axisSelector + 'Placeholder'));
                    icon.css('marginBottom', '0px');
                }
            }
        } else {
            document.getElementById('inputColumn').style.display = '';
            document.getElementById('outputColumn').style.display = '';
            document.getElementById('matrixColumn').style.display = 'none';

            for (const io of ['input', 'output']) {
                for (const axis of axes) {
                    const axisSelector = '#' + io + axis;
                    const icon = $(axisSelector);
                    icon.appendTo($('#' + io + 'Column'));
                    icon.css('marginBottom', '20px');
                }
            }
        }
    }

    window.onload = function () {
        const cells = document.getElementsByTagName('td');
        for (let i = 0; i < cells.length; i++) {
            cells[i].onclick = matrixClickHandler;
        }
    };

    function mapNumberToAxis(number) {
        switch (number) {
            case 0:
                return 'R1';
            case 1:
                return 'R2';
            case 2:
                return 'R3';
            case 3:
                return 'T1';
            case 4:
                return 'T2';
            case 5:
                return 'T3';
            default:
                return undefined;
        }
    }

    function matrixClickHandler(e) {
        // https://stackoverflow.com/a/12193346/8816968
        e = e || window.event;
        const cell = e.target || e.srcElement;
        const inputIndex = cell.parentNode.rowIndex - 2;
        const outputIndex = cell.cellIndex - 1;
        if (inputIndex >= 0 && outputIndex >= 0) {
            selectedMatrixCells[inputIndex][outputIndex] = !selectedMatrixCells[inputIndex][outputIndex];
            if (selectedMatrixCells[inputIndex][outputIndex]) {
                cell.style.border = '5px solid rgb(0, 162, 232)';
            } else {
                cell.style.border = '0px';
            }
            updateMatrix();
            searchMechanism('http://mechanism-browser:8000/api/mechanisms/');
        }
    }

    function lerp(value, min, max) {
        return min + (max - min) * value;
    }

    function isDark(r, g, b) {
        return (r + g + b) / 3 < 130;
    }

    function setCellColor(cell, value, minValue, maxValue) {
        let colorValue = 0.0;
        if (value > maxValue) {
            colorValue = 1.0;
        } else if (value > 0) {
            colorValue = Math.min(0.9, Math.max(0.1, (value - minValue) / (maxValue - minValue)));
        }

        const startR = 180;
        const startG = 225;
        const startB = 165;
        const endR = 35;
        const endG = 105;
        const endB = 60;
        const r = lerp(colorValue, startR, endR);
        const g = lerp(colorValue, startG, endG);
        const b = lerp(colorValue, startB, endB);

        $(cell).css('background-color', 'rgb(' + r + ', ' + g + ', ' + b + ')');
        if (isDark(r, g, b)) {
            $(cell).css('color', 'white');
        } else {
            $(cell).css('color', 'black');
        }
    }

    function updateMatrix() {
        const xhttp = new XMLHttpRequest();
        const url = getUrlWithParameters('http://mechanism-browser:8000/api/mechanisms/matrix/', getParameters());
        xhttp.open('GET', url.toString());
        xhttp.setRequestHeader('Content-type', 'application/json');
        xhttp.send();
        xhttp.onreadystatechange = function () {
            if (xhttp.readyState === 4 && xhttp.status === 200) {
                const response = JSON.parse(xhttp.responseText);
                let minValue = 0;
                let maxValue = 0;
                for (let y = 0; y < 6; y++) {
                    for (let x = 0; x < 6; x++) {
                        minValue = Math.min(minValue, response[y][x]);
                        maxValue = Math.max(maxValue, response[y][x]);
                    }
                }

                for (let y = 0; y < 6; y++) {
                    for (let x = 0; x < 6; x++) {
                        const row = y + 2;
                        const column = x + 1;
                        const cell = $('#matrix')[0].rows[row].cells[column];
                        cell.textContent = response[y][x];
                        setCellColor(cell, response[y][x], minValue, maxValue)
                    }
                }
            }
        };
    }

    updateMatrix();
</script>
</html>
